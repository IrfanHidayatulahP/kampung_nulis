<%- include('../../partials/header.ejs') %>
    <div class="container mt-4">
        <h2>Detail Transaksi #<%= transaksi.id_transaksi %>
        </h2>

        <div class="card mb-3">
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-3">Username</dt>
                    <dd class="col-sm-9">
                        <%= transaksi.username %>
                    </dd>

                    <dt class="col-sm-3">Tanggal Sewa</dt>
                    <dd class="col-sm-9">
                        <%= transaksi.tgl_sewa %>
                    </dd>

                    <dt class="col-sm-3">Tanggal Pengembalian</dt>
                    <dd class="col-sm-9">
                        <%= transaksi.tgl_pengembalian || '-' %>
                    </dd>

                    <dt class="col-sm-3">Status</dt>
                    <dd class="col-sm-9">
                        <%= transaksi.status_transaksi %>
                    </dd>

                    <dt class="col-sm-3">Total Biaya Sewa</dt>
                    <dd class="col-sm-9">
                        Rp <%= (Number(transaksi.total_biaya_sewa) || 0).toLocaleString('id-ID', {
                            minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
                    </dd>

                    <dt class="col-sm-3">Total DP</dt>
                    <dd class="col-sm-9">
                        Rp <%= (Number(transaksi.total_dp) || 0).toLocaleString('id-ID', { minimumFractionDigits: 0,
                            maximumFractionDigits: 0 }) %>
                    </dd>
                </dl>

                <div class="mt-3">
                    <a href="/transaksi/edit/<%= transaksi.id_transaksi %>" class="btn btn-warning">Edit</a>

                    <form action="/transaksi/delete/<%= transaksi.id_transaksi %>" method="post" style="display:inline"
                        onsubmit="return confirm('Hapus transaksi ini?');">
                        <button class="btn btn-danger">Hapus</button>
                    </form>

                    <a href="/transaksi/list-transaksi" class="btn btn-secondary">Kembali</a>
                </div>
            </div>
        </div>

        <!-- Daftar barang yang disewa -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Barang yang disewa</h5>

                <% // pakai properti sesuai association: detail_transaksis const
                    details=Array.isArray(transaksi.detail_transaksis) ? transaksi.detail_transaksis : []; let
                    grandTotal=0; %>

                    <% if (details.length> 0) { %>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="thead-light">
                                    <tr>
                                        <th style="width:48px">#</th>
                                        <th>Nama Barang</th>
                                        <th style="width:120px">Jumlah</th>
                                        <th style="width:160px">Harga / Satuan</th>
                                        <th style="width:160px">Total Harga</th>
                                        <th style="width:140px">Kembali Bagus</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% details.forEach(function(d, idx) { const jumlah=Number(d.jumlah_sewa) || 0; const
                                        hargaSatuan=Number(d.harga_sewa_per_satuan) || 0; const
                                        totalItem=Number(d.total_harga_sewa) || (jumlah * hargaSatuan) || 0; grandTotal
                                        +=totalItem; let namaBarang='-' ; if (d.barang && (d.barang.nama_barang ||
                                        d.barang.nama)) { namaBarang=d.barang.nama_barang || d.barang.nama; } else if
                                        (d.nama_barang) { namaBarang=d.nama_barang; } else if (d.id_barang) {
                                        namaBarang='ID: ' + d.id_barang; } %>
                                        <tr>
                                            <td>
                                                <%= idx + 1 %>
                                            </td>
                                            <td>
                                                <%= namaBarang %>
                                            </td>
                                            <td class="text-center">
                                                <%= jumlah %>
                                            </td>
                                            <td class="text-right">
                                                Rp <%= (hargaSatuan).toLocaleString('id-ID', { minimumFractionDigits: 0,
                                                    maximumFractionDigits: 0 }) %>
                                            </td>
                                            <td class="text-right">
                                                Rp <%= (totalItem).toLocaleString('id-ID', { minimumFractionDigits: 0,
                                                    maximumFractionDigits: 0 }) %>
                                            </td>
                                            <td class="text-center">
                                                <%= Number(d.qty_kembali_bagus || 0) %>
                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="4" class="text-right">Grand Total</th>
                                        <th class="text-right">Rp <%= (grandTotal).toLocaleString('id-ID', {
                                                minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
                                        </th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <% } else { %>
                            <p class="mb-0">Tidak ada barang untuk transaksi ini. (Jika Anda yakin harus ada, pastikan
                                controller meng-attach <code>transaksi.detail_transaksis</code> â€” gunakan association
                                atau fetch terpisah.)</p>
                            <% } %>
            </div>
        </div>
    </div>
    <%- include('../../partials/footer.ejs') %>