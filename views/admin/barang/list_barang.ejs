<%- include('../../partials/header.ejs') %>
    <% const rawRole=(user && (user.role || user.status)) || '' ; const
        roleNorm=String(rawRole).toLowerCase().replace(/\s+/g,'').replace(/[_-]/g,''); const isAdmin=roleNorm==='admin'
        ; %>

        <div class="container" style="padding: 100px 10px 10px 10px; max-width: 1200px; margin: 0 auto;">
            <div class="page-content">
                <div class="section-header" style="margin-bottom: 30px;">
                    <div>
                        <h2 style="margin: 0; color: #1e293b; font-size: 2rem;">Daftar Barang</h2>
                        <p style="margin: 5px 0 0 0; color: #64748b; font-size: 0.95rem;">Kelola dan lihat semua barang
                            tersedia</p>
                    </div>
                    <% if (isAdmin) { %>
                        <a href="/barang/create" class="btn-tambah">
                            <span>‚ûï</span> Tambah Barang
                        </a>
                        <% } %>
                </div>

                <% if (typeof error !=='undefined' && error) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert"
                        style="border-radius: 10px; border: none; margin-bottom: 20px;">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        <%= error %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <% } %>

                        <% if (typeof success !=='undefined' && success) { %>
                            <div class="alert alert-success alert-dismissible fade show" role="alert"
                                style="border-radius: 10px; border: none; margin-bottom: 20px;">
                                <i class="bi bi-check-circle me-2"></i>
                                <%= success %>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"
                                        aria-label="Close"></button>
                            </div>
                            <% } %>

                                <div class="search-section">
                                    <form action="/barang/list-barang" method="GET" class="search-form" id="searchForm">
                                        <div class="search-input-wrapper">
                                            <span class="search-icon">üîç</span>
                                            <input type="text" name="q" id="searchInput"
                                                placeholder="Cari nama barang atau ID..."
                                                value="<%= typeof filter_q !== 'undefined' ? filter_q : '' %>"
                                                class="search-input" onkeyup="liveSearch()">

                                            <% if (typeof filter_q !=='undefined' && filter_q) { %>
                                                <a href="/barang/list-barang" class="clear-search">&times;</a>
                                                <% } %>
                                        </div>
                                        <button type="submit" class="btn-search">Cari</button>
                                    </form>
                                </div>

                                <div class="barang-grid">
                                    <% if (records && records.length> 0) { %>
                                        <% records.forEach(function(b) { %>
                                            <div class="barang-card">
                                                <div class="barang-img-container">
                                                    <% if (b.photo_path) { %>
                                                        <img src="<%= b.photo_path %>" alt="<%= b.nama_barang %>">
                                                        <% } else { %>
                                                            <div class="no-img">
                                                                <i class="bi bi-image"
                                                                    style="font-size: 2rem; color: #ccc;"></i>
                                                            </div>
                                                            <% } %>

                                                                <div
                                                                    class="stock-badge <%= b.stok_tersedia > 0 ? 'in-stock' : 'out-stock' %>">
                                                                    <%= b.stok_tersedia %>
                                                                        <%= b.satuan_jumlah || 'unit' %>
                                                                </div>
                                                </div>

                                                <div class="barang-content">
                                                    <h4>
                                                        <%= b.nama_barang %>
                                                    </h4>

                                                    <p class="stok-info">
                                                        Total Stok: <strong>
                                                            <%= b.jumlah_total %>
                                                                <%= b.satuan_jumlah || 'unit' %>
                                                        </strong>
                                                    </p>

                                                    <p class="harga-info">
                                                        Rp <%= (b.harga_dasar_sewa || 0).toLocaleString('id-ID') %>
                                                    </p>

                                                    <div class="action-buttons">
                                                        <a href="/barang/detail/<%= b.id_barang %>"
                                                            class="btn-action btn-lihat" title="Lihat">
                                                            <span>üëÅÔ∏è</span>
                                                        </a>

                                                        <% if (isAdmin) { %>
                                                            <a href="/barang/edit/<%= b.id_barang %>"
                                                                class="btn-action btn-edit" title="Edit">
                                                                <span>‚úèÔ∏è</span>
                                                            </a>

                                                            <form action="/barang/delete/<%= b.id_barang %>"
                                                                method="post" class="form-hapus"
                                                                onsubmit="return confirm('Hapus barang ini?');">
                                                                <button type="submit" class="btn-action btn-hapus"
                                                                    title="Hapus">
                                                                    <span>üóëÔ∏è</span>
                                                                </button>
                                                            </form>
                                                            <% } %>
                                                    </div>
                                                </div>
                                            </div>
                                            <% }); %>
                                                <% } else { %>
                                                    <div class="empty-state"
                                                        style="grid-column: 1/-1; text-align: center; padding: 60px 30px; background: #f9f9f9; border-radius: 12px;">
                                                        <div style="font-size: 3rem; margin-bottom: 15px;">üì¶</div>
                                                        <p style="color: #64748b; font-size: 1.1rem;">Data barang tidak
                                                            ditemukan</p>
                                                    </div>
                                                    <% } %>
                                </div>
            </div>
        </div>

        <style>
            /* CSS ORIGINAL ANDA DENGAN PENYESUAIAN GRID */
            .container {
                /* Padding top 100px agar tidak tertutup header */
                padding: 10px 10px 10px 10px !important;
                max-width: 1200px;
                margin: 0 auto;
            }

            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                border-left: 4px solid #007bff;
                padding-left: 15px;
            }

            .btn-tambah {
                background: #007bff;
                color: white;
                text-decoration: none;
                padding: 10px 25px;
                border-radius: 10px;
                font-weight: bold;
                transition: 0.3s;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .search-form {
                display: flex;
                gap: 10px;
                max-width: 700px;
                margin: 0 auto;
            }

            .search-input-wrapper {
                position: relative;
                flex-grow: 1;
                display: flex;
                align-items: center;
            }

            .search-input {
                width: 100%;
                padding: 12px 40px 12px 45px;
                border-radius: 10px;
                border: 1px solid #cbd5e1;
            }

            .btn-search {
                padding: 12px 30px;
                border-radius: 10px;
                border: none;
                background: #1e293b;
                color: white;
                cursor: pointer;
            }

            /* Cari bagian ini di CSS Anda */
            .search-section {
                margin-bottom: 30px;
                /* Ubah dari 30px menjadi 50px atau sesuai selera */
            }

            /* GRID DIUBAH MENJADI 4 KOLOM */
            .barang-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                /* 4 kolom mendatar */
                gap: 20px;
            }

            .barang-card {
                background: white;
                border-radius: 12px;
                overflow: hidden;
                border: 1px solid #eee;
                display: flex;
                flex-direction: column;
                transition: 0.3s;
            }

            .barang-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }

            .barang-img-container {
                position: relative;
                width: 100%;
                height: 160px;
                overflow: hidden;
            }

            .barang-img-container img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .stock-badge {
                position: absolute;
                top: 10px;
                right: 10px;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 0.7rem;
                color: white;
                font-weight: bold;
            }

            .stock-badge.in-stock {
                background: #22c55e;
            }

            .stock-badge.out-stock {
                background: #ef4444;
            }

            .barang-content {
                padding: 15px;
                flex-grow: 1;
                display: flex;
                flex-direction: column;
            }

            .barang-content h4 {
                margin: 0 0 8px 0;
                font-size: 1rem;
                color: #1e293b;
                height: 2.6em;
                overflow: hidden;
            }

            .harga-info {
                font-size: 1.1rem;
                color: #16a34a;
                font-weight: bold;
                margin-bottom: 15px;
            }

            /* TOMBOL AKSI MENYAMPING */
            .action-buttons {
                display: flex;
                gap: 5px;
            }

            .btn-action {
                flex: 1;
                padding: 8px 5px;
                border-radius: 6px;
                text-decoration: none;
                font-size: 0.8rem;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .btn-lihat {
                background: #e0f2fe;
                color: #0369a1;
            }

            .btn-edit {
                background: #fef3c7;
                color: #b45309;
            }

            .btn-hapus {
                background: #fee2e2;
                color: #991b1b;
                width: 100%;
                border: none;
            }

            .form-hapus {
                flex: 1;
                display: flex;
            }

            /* RESPONSIVE */
            @media (max-width: 1024px) {
                .barang-grid {
                    grid-template-columns: repeat(3, 1fr);
                }
            }

            @media (max-width: 768px) {
                .barang-grid {
                    grid-template-columns: repeat(2, 1fr);
                }

                .container {
                    padding-top: 10px !important;
                }
            }

            @media (max-width: 480px) {
                .barang-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>

        <script>
            function liveSearch() {
                let input = document.getElementById('searchInput').value.toLowerCase();
                let cards = document.getElementsByClassName('barang-card');
                for (let i = 0; i < cards.length; i++) {
                    let title = cards[i].querySelector('h4').innerText.toLowerCase();
                    cards[i].style.display = title.includes(input) ? "" : "none";
                }
            }
        </script>

        <%- include('../../partials/footer.ejs') %>