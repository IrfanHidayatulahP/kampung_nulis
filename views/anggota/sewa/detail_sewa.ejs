<%- include('../../partials/header.ejs') %>

<% 
  const _user = (typeof user !== 'undefined' && user) ? user : null;
  const role = (_user && (_user.role || _user.status || '')) ? String(_user.role || _user.status).toString().trim().toLowerCase() : '';
  // safe fallback untuk barangs supaya template tidak crash bila controller belum mengirim
  const _barangs = (typeof barangs !== 'undefined' && Array.isArray(barangs)) ? barangs : [];
%>

<section class="container">
  <% if (role !== 'anggota') { %>
    <h2>Akses ditolak</h2>
    <p>Halaman ini hanya untuk <strong>Anggota</strong>.</p>

  <% } else if (!transaksi) { %>
    <h2>Transaksi tidak ditemukan</h2>
    <p>Transaksi yang anda pilih tidak tersedia.</p>

  <% } else if (String(transaksi.username) !== String(_user?.username)) { %>
    <h2>Akses ditolak</h2>
    <p>Anda tidak berwenang melihat transaksi ini (bukan pemilik).</p>

  <% } else { %>
    <!-- MAIN CONTENT -->
    <h1>Detail Transaksi #<%= transaksi.id_transaksi %></h1>

    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <% if (success) { %>
      <div class="alert alert-success"><%= success %></div>
    <% } %>

    <div class="card">
      <p><strong>Username:</strong> <%= transaksi.username %></p>
      <p><strong>Tgl Sewa:</strong> <%= transaksi.tgl_sewa %></p>
      <p><strong>Tgl Pengembalian (expected):</strong> <%= transaksi.tgl_pengembalian || '-' %></p>
      <p><strong>Status:</strong> <%= transaksi.status_transaksi %></p>
      <p><strong>Total Biaya:</strong> <%= transaksi.total_biaya_sewa != null ? transaksi.total_biaya_sewa : '-' %></p>
    </div>

    <!-- Item pada Transaksi -->
    <div class="card" style="margin-top:12px;">
      <h3>Item pada Transaksi</h3>

      <% if (!details || details.length === 0) { %>
        <p>Belum ada item pada transaksi ini.</p>
      <% } else { %>
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Nama Barang</th>
              <th>Jumlah Pinjam</th>
              <th>Kembali (bagus)</th>
              <th>Harga/satuan</th>
              <th>Total</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            <% details.forEach(function(d, idx) { %>
              <tr>
                <td><%= idx + 1 %></td>
                <td><%= d.barang ? d.barang.nama_barang : ('ID:' + d.id_barang) %></td>
                <td><%= d.jumlah_sewa %></td>
                <td><%= d.qty_kembali_bagus || 0 %></td>
                <td><%= d.harga_sewa_per_satuan %></td>
                <td><%= d.total_harga_sewa != null ? d.total_harga_sewa : '-' %></td>
                <td>
                  <!-- update qty -->
                  <form action="/sewa/<%= transaksi.id_transaksi %>/item/<%= d.id_barang %>/update" method="POST" style="display:inline-block">
                    <input type="number" name="jumlah_sewa" value="<%= d.jumlah_sewa %>" min="0" style="width:72px" required />
                    <button type="submit">Update</button>
                  </form>

                  <!-- delete item -->
                  <form action="/sewa/<%= transaksi.id_transaksi %>/item/<%= d.id_barang %>/delete" method="POST" style="display:inline-block; margin-left:6px">
                    <button type="submit" onclick="return confirm('Hapus item ini?')">Hapus</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>

    <!-- Tombol & Panel Tambah Barang -->
    <div style="margin:10px 0">
      <button type="button" id="btnToggleAdd" onclick="toggleAddPanel()">+ Tambah Jenis Barang</button>
    </div>

    <div id="addPanel" style="display:none; border:1px solid #ddd; padding:12px; margin-bottom:12px; background:#fafafa;">
      <h3>Tambah beberapa barang ke keranjang</h3>

      <% if (_barangs.length === 0) { %>
        <p>Tidak ada barang tersedia.</p>
      <% } else { %>
        <!-- batch add form -->
        <form action="/sewa/<%= transaksi.id_transaksi %>/add" method="POST">
          <table class="table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="width:40px">Pilih</th>
                <th>Nama Barang</th>
                <th style="width:120px">Jumlah</th>
                <th style="width:120px">Stok</th>
              </tr>
            </thead>
            <tbody>
              <% _barangs.forEach(function(b) { %>
                <tr>
                  <td style="text-align:center;">
                    <input type="checkbox" name="items[<%= b.id_barang %>][selected]" value="1" />
                  </td>
                  <td><%= b.nama_barang %></td>
                  <td>
                    <input type="number" name="items[<%= b.id_barang %>][qty]" value="1" min="1" style="width:72px" />
                  </td>
                  <td><%= (b.stok_tersedia != null) ? b.stok_tersedia : '-' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>

          <div style="margin-top:8px">
            <button type="submit">Tambahkan yang dipilih</button>
            <button type="button" onclick="toggleAddPanel()" style="margin-left:8px">Batal</button>
          </div>
        </form>

        <hr style="margin:12px 0">

        <!-- quick single-add (legacy fallback id_barang + jumlah_sewa) -->
        <form action="/sewa/<%= transaksi.id_transaksi %>/add" method="POST" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label for="quick_id">Tambah cepat:</label>
          <select id="quick_id" name="id_barang" required>
            <option value="">-- Pilih barang --</option>
            <% _barangs.forEach(function(b) { %>
              <option value="<%= b.id_barang %>"><%= b.nama_barang %> (stok: <%= (b.stok_tersedia != null) ? b.stok_tersedia : '-' %>)</option>
            <% }) %>
          </select>
          <input type="number" name="jumlah_sewa" value="1" min="1" style="width:80px" required />
          <button type="submit">Tambah</button>
        </form>
      <% } %>
    </div>

    <script>
      function toggleAddPanel() {
        var el = document.getElementById('addPanel');
        if (!el) return;
        el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
      }
    </script>

    <!-- Checkout & kembali -->
    <div style="margin-top:12px">
      <form action="/sewa/<%= transaksi.id_transaksi %>/checkout" method="POST" onsubmit="return confirm('Checkout? Stok akan dikurangi.')">
        <button type="submit">Checkout</button>
      </form>
      <a href="/sewa/list-sewa" style="margin-left:12px">Kembali</a>
    </div>

  <% } /* end main else (owner & transaksi valid) */ %>
</section>

<%- include('../../partials/footer.ejs') %>
