<%- include('../partials/header.ejs') %>

    <div class="container" style="padding: 0 10px 10px 10px; max-width: 1200px; margin: 0 auto;">
        <div class="page-content">
            <div class="dashboard-actions">
                <a href="/sewa/cart" class="action-card">
                    <div class="action-icon cart-icon">üõí</div>
                    <div class="action-text">
                        <span class="action-title">Keranjang</span>
                        <span class="action-desc">Barang siap sewa</span>
                    </div>
                    <span class="count-badge">!</span>
                </a>

                <a href="/sewa/list-sewa" class="action-card">
                    <div class="action-icon history-icon">üìú</div>
                    <div class="action-text">
                        <span class="action-title">Riwayat Transaksi</span>
                        <span class="action-desc">Cek status sewa Anda</span>
                    </div>
                </a>
            </div>

            <div class="search-section">
                <form action="/anggota/dashboard" method="GET" class="search-form" id="searchForm">
                    <div class="search-input-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" name="q" id="searchInput" placeholder="Cari nama barang..."
                            value="<%= typeof filter_q !== 'undefined' ? filter_q : '' %>" class="search-input"
                            onkeyup="liveSearch()">

                        <% if (typeof filter_q !=='undefined' && filter_q) { %>
                            <a href="/anggota/dashboard" class="clear-search">&times;</a>
                            <% } %>
                    </div>
                    <button type="submit" class="btn-search">Cari</button>
                </form>
            </div>

            <div class="section-header">
                <h3>Daftar Barang Tersedia</h3>
                <a href="/barang/list-barang" class="see-all">Lihat Semua ‚Üí</a>
            </div>

            <div class="barang-grid">
                <% if (items && items.length> 0) { %>
                    <% items.forEach(item=> { %>
                        <div class="barang-card">
                            <div class="barang-img-container">
                                <% if (item.photo_path) { %>
                                    <img src="<%= item.photo_path %>" alt="<%= item.nama_barang %>">
                                    <% } else { %>
                                        <div class="no-img">Tidak ada foto</div>
                                        <% } %>
                            </div>
                            <div class="barang-content">
                                <h4>
                                    <%= item.nama_barang %>
                                </h4>
                                <p class="stok-status">Tersedia: <strong>
                                        <%= item.stok_tersedia %>
                                    </strong></p>

                                <p class="harga-info">Rp <%= Number(item.display_price || 0).toLocaleString('id-ID') %>
                                        / hari</p>

                                <button type="button" class="btn-pesan"
                                    onclick="openOrderModal('<%= item.id %>', '<%= item.nama_barang %>', '<%= item.stok_tersedia %>', '<%= item.harga_dasar_sewa %>')">
                                    Pesan Sekarang
                                </button>
                            </div>
                        </div>
                        <% }) %>
                            <% } else { %>
                                <div class="empty-state"
                                    style="grid-column: 1/-1; text-align: center; padding: 50px; background: #f9f9f9; border-radius: 12px;">
                                    <p>Belum ada barang yang tersedia.</p>
                                </div>
                                <% } %>
            </div>

            <div id="orderModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Konfirmasi Penyewaan</h3>
                        <span class="close-modal" onclick="closeOrderModal()">&times;</span>
                    </div>
                    <form action="/sewa/add-to-cart" method="POST">
                        <div class="modal-body">
                            <input type="hidden" name="id_barang" id="modal_id_barang">

                            <div class="info-group">
                                <label>Nama Barang:</label>
                                <p id="modal_nama_barang" class="info-text-bold"></p>
                            </div>

                            <div class="info-group">
                                <label>Jumlah Sewa:</label>
                                <input type="number" name="jumlah_sewa" id="modal_jumlah_input" min="1" value="1"
                                    required oninput="calculateTotal()" class="form-input">
                                <small class="text-muted">Maksimal stok: <span id="modal_max_stok"></span></small>
                            </div>

                            <div class="info-group price-box">
                                <label>Total Biaya Sewa:</label>
                                <p id="modal_total_harga" class="price-text">Rp 0</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn-cancel" onclick="closeOrderModal()">Batal</button>
                            <button type="submit" class="btn-confirm">Konfirmasi Pesanan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Ubah padding-top menjadi lebih kecil (misal: 0 atau 10px) */
        .container {
            padding: 0px 10px 10px 10px !important;
            /* Mengurangi jarak atas */
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Jika dashboard-actions masih terlalu turun, kurangi margin-top-nya */
        .dashboard-actions {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            /* Tambahkan ini untuk kontrol manual jarak atas */
            margin-bottom: 30px;
            /* Dikurangi dari 40px agar lebih rapat ke bawah */
        }

        /* CSS Search Bar Baru */
        .search-section {
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
        }

        .search-input-wrapper {
            position: relative;
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            color: #94a3b8;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 45px;
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            font-size: 1rem;
            transition: 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .clear-search {
            position: absolute;
            right: 15px;
            text-decoration: none;
            color: #94a3b8;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .btn-search {
            padding: 0 25px;
            border-radius: 10px;
            border: none;
            background: #1e293b;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-search:hover {
            background: #0f172a;
        }

        /* CSS tetap sama seperti sebelumnya */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
            padding-left: 15px;
        }

        .see-all {
            font-size: 0.9rem;
            text-decoration: none;
            color: #007bff;
        }

        .dashboard-actions {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
        }

        .action-card {
            flex: 1;
            display: flex;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-decoration: none;
            color: #333;
            border: 1px solid #eee;
            transition: 0.3s;
            position: relative;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-color: #007bff;
        }

        .action-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .cart-icon {
            background: #e7f3ff;
        }

        .history-icon {
            background: #f0fdf4;
        }

        .action-title {
            display: block;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .action-desc {
            font-size: 0.8rem;
            color: #777;
        }

        .count-badge {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .barang-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
        }

        .barang-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            transition: 0.3s;
        }

        .barang-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }

        .barang-img-container {
            width: 100%;
            height: 180px;
            background: #f9f9f9;
        }

        .barang-img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .no-img {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
        }

        .barang-content {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .barang-content h4 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .stok-status {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 5px;
        }

        .harga-info {
            font-size: 1.1rem;
            color: #16a34a;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .btn-pesan {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            width: 100%;
        }

        .btn-pesan:hover {
            background: #0056b3;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 450px;
            overflow: hidden;
            animation: animdown 0.3s;
        }

        @keyframes animdown {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-modal {
            cursor: pointer;
            font-size: 1.5rem;
            color: #94a3b8;
        }

        .modal-body {
            padding: 20px;
        }

        .info-group {
            margin-bottom: 15px;
        }

        .info-group label {
            display: block;
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 5px;
        }

        .info-text-bold {
            font-weight: bold;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        .price-box {
            background: #f0fdf4;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px dashed #22c55e;
        }

        .price-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #16a34a;
            margin-top: 5px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancel {
            padding: 10px 20px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            background: white;
            cursor: pointer;
        }

        .btn-confirm {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .dashboard-actions {
                flex-direction: column;
            }
        }
    </style>

    <script>
        let pricePerItem = 0;

        function openOrderModal(id, nama, stok, harga) {
            document.getElementById('modal_id_barang').value = id;
            document.getElementById('modal_nama_barang').innerText = nama;
            document.getElementById('modal_max_stok').innerText = stok;

            const inputJumlah = document.getElementById('modal_jumlah_input');
            inputJumlah.max = stok;
            inputJumlah.value = 1;

            pricePerItem = parseFloat(harga) || 0;
            calculateTotal();

            document.getElementById('orderModal').style.display = 'flex';
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        function calculateTotal() {
            const jumlah = document.getElementById('modal_jumlah_input').value || 0;
            const total = jumlah * pricePerItem;
            document.getElementById('modal_total_harga').innerText = 'Rp ' + total.toLocaleString('id-ID');
        }

        window.onclick = function (event) {
            const modal = document.getElementById('orderModal');
            if (event.target == modal) closeOrderModal();
        }

        function liveSearch() {
            // Ambil teks pencarian
            let input = document.getElementById('searchInput').value.toLowerCase();

            // Ambil semua elemen kartu barang
            let cards = document.getElementsByClassName('barang-card');
            let container = document.querySelector('.barang-grid');
            let hasVisibleCard = false;

            for (let i = 0; i < cards.length; i++) {
                // Ambil teks nama barang dari h4 di dalam kartu
                let title = cards[i].querySelector('h4').innerText.toLowerCase();

                if (title.includes(input)) {
                    cards[i].style.display = ""; // Tampilkan
                    hasVisibleCard = true;
                } else {
                    cards[i].style.display = "none"; // Sembunyikan
                }
            }

            // Jika ingin menampilkan pesan "Barang tidak ditemukan" secara dinamis
            let emptyMsg = document.getElementById('live-empty-state');
            if (!hasVisibleCard) {
                if (!emptyMsg) {
                    let div = document.createElement('div');
                    div.id = 'live-empty-state';
                    div.style.gridColumn = "1/-1";
                    div.style.textAlign = "center";
                    div.style.padding = "40px";
                    div.innerHTML = `<p style="color: #64748b;">Barang "${input}" tidak ditemukan.</p>`;
                    container.appendChild(div);
                }
            } else if (emptyMsg) {
                emptyMsg.remove();
            }
        }
    </script>